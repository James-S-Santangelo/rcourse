<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Madeleine Bonsma-Fisher" />


<title>Fitting models to data</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="image/favicon.png">
<style type="text/css">

table {
    border-collapse: collapse;
}

thead {
    border-top: solid #DCDCDC;
    border-bottom: solid #DCDCDC;
}

tr.odd {
    background-color: #F8F8F8;
}

tr:last-child {
    border-bottom: solid #DCDCDC;
}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EEB430H1</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-map-o"></span>
     
    Syllabus
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lec01-introduction.html">Sept. 7: Intro to course, programming, RStudio, and R Markdown</a>
    </li>
    <li>
      <a href="lec02-basic-r.html">Sept. 12: Variable assignment, vectors, functions</a>
    </li>
    <li>
      <a href="lec03-basic-r.html">Sept. 14: Data frames, intro to dplyr</a>
    </li>
    <li>
      <a href="lec04-dplyr.html">Sept. 19: Data wrangling in dplyr, tidy data</a>
    </li>
    <li>
      <a href="lec05-dplyr.html">Sept. 21: More dplyr and tidy data, ggplot intro</a>
    </li>
    <li>
      <a href="lec06-pop-models.html">Sept. 26: Qualitative review of population models</a>
    </li>
    <li>
      <a href="lec07-pop-models.html">Sept. 28: Modelling in R</a>
    </li>
    <li>
      <a href="lec08-stability.html">Oct. 03: Population models in two dimensions</a>
    </li>
    <li>
      <a href="lec09-modeling-r.html">Oct. 05: Fixed points, null clines, and stability</a>
    </li>
    <li>
      <a href="lec10-modelling.html">Oct. 10: Fitting models to data</a>
    </li>
    <li>
      <a href="lec11-modelling.html">Oct. 12: Statistical and probabilistic modelling in R</a>
    </li>
    <li>
      <a href="lec12-datasets.html">Oct. 17: Scientific method, team dynamics, and project datasets</a>
    </li>
    <li>
      <a href="lec13-projects-r.html">Oct. 19: Project and Git in RStudio, and project work</a>
    </li>
    <li>
      <a href="lec14-git.html">Oct. 24: Scientific collaboration, Git and GitHub</a>
    </li>
    <li>
      <a href="lec15-data-viz.html">Oct. 26: Data visualization and project work</a>
    </li>
    <li>
      <a href="lec16-data-viz.html">Oct. 31: Project work, data visualizations</a>
    </li>
    <li>
      <a href="lec17-rmarkdown.html">Nov. 02: Reproducible workflow, Metadata, and R Markdown</a>
    </li>
    <li class="dropdown-header">Nov. 14: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 16: Project work (no lesson)</li>
    <li>
      <a href="lec20-publishing.html">Nov. 21: Preparing a scientific item for academic publishing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="assignment-01.html">Assignment 1</a>
    </li>
    <li>
      <a href="assignment-02.html">Assignment 2</a>
    </li>
    <li>
      <a href="assignment-03.html">Assignment 3</a>
    </li>
    <li>
      <a href="assignment-04.html">Assignment 4</a>
    </li>
    <li>
      <a href="assignment-05.html">Assignment 5</a>
    </li>
    <li>
      <a href="assignment-06.html">Assignment 6</a>
    </li>
    <li>
      <a href="assignment-07.html">Assignment 7</a>
    </li>
    <li>
      <a href="assignment-08.html">Assignment 8</a>
    </li>
    <li>
      <a href="assignment-final.html">Final assignment</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-caret-square-o-right"></span>
     
    Slides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="slides/lec12-datasets.html">Oct. 17: Scientific method, team dynamics, and project datasets</a>
    </li>
  </ul>
</li>
<li>
  <a href="resources.html">
    <span class="fa fa-question"></span>
     
    Resources and FAQ
  </a>
</li>
<li>
  <a href="about.html">
    <span class="fa fa-info"></span>
     
    About
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bars"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="mailto:joel.ostblom@mail.utoronto.ca">
        <span class="fa fa-envelope"></span>
         
        Contact
      </a>
    </li>
    <li>
      <a href="https://github.com/uoftcoders/rcourse">
        <span class="fa fa-github"></span>
         
        GitHub
      </a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Fitting models to data</h1>
<h4 class="author"><em>Madeleine Bonsma-Fisher</em></h4>

</div>


<div id="lesson-preamble" class="section level2">
<h2>Lesson preamble</h2>
<blockquote>
<h3 id="learning-objectives">Learning objectives</h3>
<ul>
<li>Appreciate bifurcations in models</li>
<li>Use least squares to fit a model to data</li>
</ul>
<h3 id="lesson-outline">Lesson outline</h3>
<p>Total lesson time: 2 hours</p>
<ul>
<li>Review eigenvalues and eigenvectors (10 minutes)</li>
<li>Vectorizing linear systems of differential equations: another perspective on eigenvalues (20 minutes)</li>
<li>Bifurcations (20 minutes)</li>
<li>Fitting models to data
<ul>
<li>Fitting simulated data for a single parameters (20 minutes)</li>
<li>Fitting real data for two parameters (40 minutes)</li>
</ul></li>
</ul>
<h3 id="setup">Setup</h3>
<ul>
<li>Download <a href="https://uoftcoders.github.io/rcourse/data/plant-biomass-preprocess.csv">this plant biomass dataset</a> and put it in your working directory.</li>
<li><code>install.packages('lattice')</code></li>
<li><code>install.packages('phaseR')</code></li>
<li><code>install.packages('deSolve')</code></li>
<li><code>install.packages('ggplot2')</code> (or <code>tidyverse</code>)</li>
<li><code>install.packages('dplyr')</code> (or <code>tidyverse</code>)</li>
<li><code>install.packages('tidyr')</code> (or <code>tidyverse</code>)</li>
</ul>
</blockquote>
</div>
<div id="recap-quantitative-analysis-of-fixed-points-and-stability" class="section level2">
<h2>Recap: quantitative analysis of fixed points and stability</h2>
<p>Here are the steps to quantitatively analyze a model. These steps are written for a two-dimensional system, but they can be applied to a system of any number of dimensions.</p>
<p>This is a generic two-dimensional system. There are two differential equations, and each is a function of both <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>.</p>
<p><span class="math display">\[ \frac{dx}{dt} = f(x, y) \\
\frac{dy}{dt} = g(x,y)\]</span></p>
<ol style="list-style-type: decimal">
<li><p><strong>Fixed points</strong>: Find all combinations of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> that satisfy <span class="math inline">\(f(x, y) = 0\)</span> and <span class="math inline">\(g(x, y) = 0\)</span>.</p></li>
<li><p><strong>Stability</strong>: Calculate the Jacobian matrix and find its eigenvalues for each fixed point. This is the Jacobian matrix:</p></li>
</ol>
<p><span class="math display">\[J=\begin{bmatrix}
    \frac{\partial f}{\partial x} &amp; \frac{\partial f}{\partial y} \\
    \frac{\partial g}{\partial x} &amp; \frac{\partial g}{\partial y}
\end{bmatrix}\]</span></p>
<ul>
<li>Find eigenvalues at each fixed point using the function <code>eigen</code> in R, or by solving the equation <span class="math inline">\(\text{Det}(A - \lambda \mathbb{1}) = 0\)</span>.</li>
<li>For a set of eigenvalues (<span class="math inline">\(\lambda_1\)</span>, <span class="math inline">\(\lambda_2\)</span>):
<ul>
<li>If all eigenvalues have negative real parts, the fixed point is <strong>stable</strong>.</li>
<li>If one or more eigenvalues has a positive real part, the fixed point is <strong>unstable</strong>.</li>
<li>If the eigenvalues have an imaginary (<strong>complex</strong>) part, the fixed point is <strong>oscillatory</strong>.</li>
</ul></li>
</ul>
</div>
<div id="vectorizing-systems-of-differential-equations" class="section level2">
<h2>Vectorizing systems of differential equations</h2>
<p>To see why eigenvalues tell us about the stability of a fixed point, let’s look at a linear system of differential equations and its solution.</p>
<p>Consider this system of differential equations:</p>
<p><span class="math display">\[\frac{d x_1}{dt}=Ax_1+Bx_2 \\
\frac{d x_2}{dt} = Cx_1+Dx_2\]</span></p>
<p>This system is <strong>linear</strong>: each term only has either <span class="math inline">\(x_1\)</span> or <span class="math inline">\(x_2\)</span> in it, and there are no terms that have higher powers of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> (such as <span class="math inline">\(x_1 x_2\)</span> or <span class="math inline">\(x_1^2\)</span>).</p>
<p>Because it’s linear, this system can be written as a matrix equation:</p>
<p><span class="math display">\[\frac{d \vec{x}}{dt} = E\vec{x}\]</span></p>
<p>where <span class="math inline">\(\vec{x}\)</span> is two-element vector <span class="math inline">\((x_1,x_2)\)</span>, <span class="math inline">\(\frac{d \vec{x}}{dt}\)</span> is also a two-element vector <span class="math inline">\((\frac{d x_1}{dt}, \frac{d x_2}{dt})\)</span>, and</p>
<p><span class="math display">\[E=\begin{bmatrix}
    A &amp; B \\
    C &amp; D 
\end{bmatrix}\]</span></p>
<p>To solve this, we assume that solutions exist of the form <span class="math inline">\(\vec{x} = \text{e}^{\lambda t} \vec{v}\)</span>, where <span class="math inline">\(\vec{v}\)</span> is an unknown fixed vector (basically a “direction”), and <span class="math inline">\(\lambda\)</span> is a growth rate, also unknown. If we can find solutions of this form, we know they correspond to exponential growth or decay in the direction described by <span class="math inline">\(\vec{v}\)</span>.</p>
<p>Plugging <span class="math inline">\(\vec{x}\)</span> into the vector equation above:</p>
<p><span class="math display">\[  \frac{d \vec{x}}{dt} = \frac{d}{dt} \text{e}^{\lambda t} \vec{v} = \lambda\text{e}^{\lambda t} \vec{v} \]</span></p>
<p><span class="math display">\[\lambda\text{e}^{\lambda t} \vec{v} = E \text{e}^{\lambda t} \vec{v} \\
E\vec{v} = \lambda \vec{v}\]</span></p>
<p>This is an eigenvalue-eigenvector equation, which means that the directions we were after are the <strong>eigenvectors</strong> of <span class="math inline">\(E\)</span>, and the growth rates are the <strong>eigenvalues</strong>.</p>
<div id="linear-system-example" class="section level3">
<h3>Linear system example</h3>
<p><span class="math display">\[\frac{dx}{dt} = y \\
\frac{dy}{dt} = -2x - 3y\]</span></p>
<p>The matrix form of this system is</p>
<p><span class="math display">\[\frac{d \vec{x}}{dt} = E\vec{x}\]</span></p>
<p>where the matrix <span class="math inline">\(E\)</span> is</p>
<p><span class="math display">\[E =  \begin{bmatrix}
    0 &amp; 1 \\
    -2 &amp; -3
\end{bmatrix}\]</span></p>
<p>To solve this system, we look for eigenvalues and eigenvectors of <span class="math inline">\(E\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>,
              -<span class="dv">2</span>, -<span class="dv">3</span>),
            <span class="dt">ncol =</span> <span class="dv">2</span>,
            <span class="dt">byrow =</span> <span class="ot">TRUE</span>)

eigenvalues &lt;-<span class="st"> </span><span class="kw">eigen</span>(E)$values
eigenvectors &lt;-<span class="st"> </span><span class="kw">eigen</span>(E)$vectors</code></pre></div>
<p>Let’s look at the eigenvectors on a phase portrait.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(phaseR)

linear_system &lt;-<span class="st"> </span>function(t, y, parameters) {

    X &lt;-<span class="st"> </span>y[<span class="dv">1</span>] <span class="co"># prey</span>
    Y &lt;-<span class="st"> </span>y[<span class="dv">2</span>] <span class="co"># predators</span>
  
    <span class="co"># calculate rate of change</span>
    dx &lt;-<span class="st"> </span>Y
    dy &lt;-<span class="st"> </span>-<span class="dv">2</span> *<span class="st"> </span>X -<span class="st"> </span><span class="dv">3</span> *<span class="st"> </span>Y
  
  <span class="co"># return rate of change</span>
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dx, dy)))
}

<span class="co"># plot vector field: on a grid of points, plot an arrow in the direction of dx/dt and dy/dt</span>
pp_flowField &lt;-<span class="st"> </span><span class="kw">flowField</span>(linear_system, <span class="dt">x.lim =</span> <span class="kw">c</span>(-<span class="dv">5</span>, <span class="dv">5</span>), <span class="dt">y.lim =</span> <span class="kw">c</span>(-<span class="dv">5</span>, <span class="dv">5</span>),
                          <span class="dt">points =</span> <span class="dv">15</span>, <span class="co"># this is the density of grid points on which to plot arrows</span>
                          <span class="dt">system =</span> <span class="st">&#39;two.dim&#39;</span>, <span class="co"># &#39;two.dim&#39; is default</span>
                          <span class="dt">add =</span> <span class="ot">FALSE</span>)

<span class="co"># add trajectories</span>
pp_trajectory &lt;-<span class="st"> </span><span class="kw">trajectory</span>(linear_system, 
                            <span class="co"># y0 is a matrix where each row is pairs of (X, Y) </span>
                            <span class="dt">y0 =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">2</span>, -<span class="dv">4</span>,
                                          -<span class="dv">4</span>, -<span class="dv">4</span>,
                                          -<span class="dv">3</span>, <span class="dv">3</span>,
                                          <span class="dv">3</span>, <span class="dv">5</span>),
                                        <span class="dt">ncol =</span> <span class="dv">2</span>,
                                        <span class="dt">byrow =</span> <span class="ot">TRUE</span>), 
                            <span class="dt">t.end =</span> <span class="dv">30</span>, <span class="co"># how far in time to calculate the trajectories</span>
                            <span class="dt">system =</span> <span class="st">&quot;two.dim&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;Note: colour has been reset as required&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># eigenvector for eigenvalue lambda = -2</span>
<span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>*eigenvectors[<span class="dv">1</span>]), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>*eigenvectors[<span class="dv">2</span>]), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;green&#39;</span>)

<span class="co"># eigenvector for eigenvalue lambda = -1</span>
<span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>*eigenvectors[<span class="dv">3</span>]), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>*eigenvectors[<span class="dv">4</span>]), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;purple&#39;</span>)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>The two eigenvector directions <span class="math inline">\(\vec{v_1}\)</span> and <span class="math inline">\(\vec{v_2}\)</span> (green and purple dashed lines) represent the directions in which the flow follows <span class="math inline">\(\text{e}^{\lambda_1 t} \vec{v_1}\)</span> or <span class="math inline">\(\text{e}^{\lambda_2 t} \vec{v_2}\)</span>. Other trajectories can be linear combinations of these two solutions:</p>
<p><span class="math display">\[\vec{x}(t) =c_l \text{e}^{\lambda_1 t} \vec{v_1} + c_2 \text{e}^{\lambda_2 t} \vec{v_2}\]</span></p>
<p>Now we can see why the eigenvalues determine stability: in a linear (or linearized) system, the eigenvalues determine whether the system shows exponential growth, decay, or oscillations, because the model solution is a combination of exponential functions whose parameters are the eigenvalues.</p>
<p>By calculating the Jacobian for any system we encounter, we are converting the system into a linear system like the one above, and all the same logic applies.</p>
</div>
</div>
<div id="bifurcations" class="section level2">
<h2>Bifurcations</h2>
<p>A <strong>bifurcation</strong> is a change in the <em>number</em> or <em>stability</em> of fixed points in a system as a function of one of the system parameters. This is a pretty abstract definition, so let’s look at an example right away.</p>
<div id="a-model-of-fishing" class="section level3">
<h3>A model of fishing</h3>
<p>Here is a model that describes the population size of a species of fish as they are being hunted.</p>
<p><span class="math display">\[\frac{dN}{dt} = rN\left(1-\frac{N}{K}\right) - HN\]</span></p>
<p>In the absence of fishing, the population is assumed to grow logistically — this is the first term in the equation. The effects of fishing are modeled by the term <span class="math inline">\(- HN\)</span>, which says that fish are caught or “harvested” at a rate that depends on <span class="math inline">\(N\)</span>. This is plausible — when fewer fish are available, it is harder to find them and so the daily catch drops.</p>
<div id="challenge" class="section level4">
<h4>Challenge</h4>
<p>Find the fixed points analytically for this system.</p>
<hr />
<p>Right away, we can see something interesting about one of the fixed points. If <span class="math inline">\(H &gt; r\)</span>, then the second fixed point becomes negative. In a real population, there would now be only a single fixed point at <span class="math inline">\(N=0\)</span> since <span class="math inline">\(N\)</span> can’t be negative.</p>
<p>Next, let’s look at the stability analytically. We calculate <span class="math inline">\(\frac{\partial f(N)}{\partial N}\)</span> and evaluate it at each fixed point, where <span class="math inline">\(f(N) = rN(1-\frac{N}{K}) - HN\)</span>.</p>
<p><span class="math display">\[\frac{\partial f(N)}{\partial N} = \frac{\partial}{\partial N} \left(rN(1-\frac{N}{K}) - HN \right) \\
=r - \frac{2rN}{K} - H\]</span></p>
<p>For the fixed point <span class="math inline">\(N=0\)</span>:</p>
<p><span class="math display">\[\frac{\partial f(N)}{\partial N} = r-H\]</span></p>
<p>This is positive if <span class="math inline">\(r &gt; H\)</span> and negative if <span class="math inline">\(r &lt; H\)</span>. This means <span class="math inline">\(H = r\)</span> is a <strong>bifurcation point</strong>: at this value of <span class="math inline">\(H\)</span> (assuming <span class="math inline">\(r\)</span> is fixed), this fixed point changes stability.</p>
<p>For the fixed point <span class="math inline">\(N = K\left(1-\frac{H}{r}\right)\)</span>:</p>
<p><span class="math display">\[\frac{\partial f(N)}{\partial N} = -r+H\]</span></p>
<p>This is positive if <span class="math inline">\(r &lt; H\)</span> and negative if <span class="math inline">\(r &gt; H\)</span>. This fixed point also changes stability at the bifurcation point <span class="math inline">\(H = r\)</span>.</p>
<p>Finally, let’s plot <span class="math inline">\(dN/dt\)</span> vs <span class="math inline">\(N\)</span> and confirm our result.</p>
<p>First, define a function for the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fishing_model &lt;-<span class="st"> </span>function(t, y, parameters) {
  
  N &lt;-<span class="st"> </span>y
  
  r &lt;-<span class="st"> </span>parameters[<span class="st">&#39;r&#39;</span>]
  K &lt;-<span class="st"> </span>parameters[<span class="st">&#39;K&#39;</span>]
  H &lt;-<span class="st"> </span>parameters[<span class="st">&#39;H&#39;</span>]
  
  dN &lt;-<span class="st"> </span>r *<span class="st"> </span>N *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>N /<span class="st"> </span>K) -<span class="st"> </span>H *<span class="st"> </span>N 
  
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dN)))
}</code></pre></div>
<p>Next, we choose parameters and create a sequence to plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">r =</span> <span class="dv">1</span>, <span class="dt">K =</span> <span class="dv">150</span>, <span class="dt">H =</span> <span class="fl">0.5</span>)

N_seq &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>)

dN_seq &lt;-<span class="st"> </span><span class="kw">fishing_model</span>(t, <span class="dt">y =</span> N_seq, <span class="dt">parameters =</span> params)</code></pre></div>
<p>And finally we plot in the usual way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

dN_seq &lt;-<span class="st"> </span><span class="kw">unlist</span>(dN_seq) <span class="co"># because our function returns a list, we need to convert it to numbers.</span>

data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(N_seq, dN_seq)

<span class="kw">ggplot</span>(data) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> N_seq, <span class="dt">y =</span> dN_seq)) +
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="fitting-models-to-data" class="section level2">
<h2>Fitting models to data</h2>
<p>Finding data is a massive field, and there are many different strategies for choosing parameters for a model depending on the assumptions you make about your data and model. Today we will talk about arguably the most common way to fit data — <strong>least squares</strong> fitting. (Linear regression, which will be covered next class, is a special case of least squares fitting.) I will show you a method for doing ‘brute force’ least squares fitting so that you can fit any model you like using the same procedure, but there are special cases you might encounter in which there are faster and/or better ways to implement least squares fitting.</p>
<div id="fitting-simulated-data-with-a-single-parameter" class="section level3">
<h3>Fitting simulated data with a single parameter</h3>
<p>Suppose we sample repeatedly from a bacterial population over time, and suppose we want to fit our sampled data to an exponential growth model.</p>
<p>Let’s simulate some data from an exponential function to work with.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">0.2</span>) <span class="co"># sample times</span>
r &lt;-<span class="st"> </span><span class="fl">0.2</span> <span class="co"># growth rate</span>
N0 &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co"># initial population</span>

<span class="co"># use the function &#39;rnorm&#39; to add noise to the data</span>
Ndata &lt;-<span class="st"> </span>N0*<span class="kw">exp</span>(r*times) +<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="kw">length</span>(times), <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.75</span>) 

<span class="kw">qplot</span>(times,Ndata) <span class="co"># check with a plot</span></code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Now let’s assume we don’t know the growth rate <span class="math inline">\(r\)</span> and we want to extract it from the data — we want to fit the data to an exponential growth model and find the value of <span class="math inline">\(r\)</span> that gives the best fit.</p>
<p>To do this, we need a way to tell if a fit is good or bad. What criteria should we use to determine if a fit is good? One option is to just try several parameter values and try to manually adjust the parameter until the fit looks good. This is imprecise and not reproducible, but it’s often a good place to start to get an idea of what parameter range to check.</p>
<p>The idea behind least squares fitting is that we want to minimize the difference between our model’s prediction and the actual data, and we do that by minimizing the sum of the <strong>squares</strong> of the <strong>residuals</strong>. Residuals (or <strong>errors</strong>) are the difference between the model and the data for each data point. The purpose of taking the square of each residual is to take out the influence of the sign of the residual.</p>
<p>The sum of the squares of the residuals is just a number, and now we have a criteria we can use to determine which of two fits is better: whichever fit minimizes that number is the better fit.</p>
<p>In practice, there are many ways to find the particular parameter that gives the best fit. One way is to start at some parameter value, then start adjusting it by small amounts and checking if the fit gets better or worse. If it gets worse, go in a different direction. If it gets better, keep going in that direction until it either starts getting worse again or the amount by which it gets better is very small. This type of algorithm is called <strong>gradient descent</strong>.</p>
<p>Another option is to try a range of parameter values and choose the one that gives the best fit out of that list. This is simpler to implement than the previous algorithm, but it’s also computationally more costly — it can take a long time.</p>
<p>We will do some examples of the second method today, what we’ll call ‘brute-force least squares’.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Make a range of r parameter values to try</span>
r_vals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.3</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)

<span class="co"># use the function &#39;sapply&#39; to loop over r_vals list</span>
resids_sq &lt;-<span class="st"> </span><span class="kw">sapply</span>(r_vals, function(r) {
    prediction &lt;-<span class="st"> </span>Ndata[<span class="dv">1</span>] *<span class="st"> </span><span class="kw">exp</span>(r *<span class="st"> </span>times)
    residuals &lt;-<span class="st"> </span>prediction -<span class="st"> </span>Ndata
    <span class="kw">sum</span>(residuals^<span class="dv">2</span>)
})</code></pre></div>
<p>Let’s plot the sum of residuals squared vs. <span class="math inline">\(r\)</span> to find which value of <span class="math inline">\(r\)</span> fits best:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(r_vals, resids_sq)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>We can see visually that the minimum is around <span class="math inline">\(r = 0.2\)</span>, but to extract that number from the list we can use the function <code>which</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">best_fit &lt;-<span class="st"> </span><span class="kw">which</span>(resids_sq ==<span class="st"> </span><span class="kw">min</span>(resids_sq))

r_fit &lt;-<span class="st"> </span>r_vals[best_fit] </code></pre></div>
<p>We got the ‘correct’ value of <span class="math inline">\(r\)</span>, the one that we originally used to simulate the data.</p>
<p>Finally, let’s plot the fit against the original data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(times,Ndata) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> times, <span class="dt">y =</span> Ndata[<span class="dv">1</span>] *<span class="st"> </span><span class="kw">exp</span>(r_fit *<span class="st"> </span>times)))</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>You can play around with this simulated data and see what happens to the fit if you change the amount of noise that gets added to the data.</p>
</div>
<div id="fitting-models-with-two-or-more-parameters" class="section level3">
<h3>Fitting models with two or more parameters</h3>
<p>Now let’s fit a model with more parameters, and let’s use some real data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The dataset downloaded at the beginning</span>
<span class="co"># https://uoftcoders.github.io/rcourse/data/plant-biomass-preprocess.csv</span>
plant_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;plant-biomass-preprocess.csv&quot;</span>)</code></pre></div>
<p>We can use our usual tricks to see what’s in our dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(plant_data) <span class="co"># create a summary of the dataset</span>

<span class="kw">head</span>(plant_data) <span class="co"># display the first few rows of the data</span>

<span class="kw">colnames</span>(plant_data) <span class="co"># show the column names</span></code></pre></div>
<p>Let’s plot just one of the habitats, sites, and treatments vs. time and colour by species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)

plant_data %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(habitat ==<span class="st"> &quot;Tundra&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(site ==<span class="st"> </span><span class="dv">3</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(treatment ==<span class="st"> &quot;rodentexclosure&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(Species, Value, -year, -treatment, -habitat, -site) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>() +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> Value, <span class="dt">color =</span> Species))</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p><em>Empetrum nigrum</em> looks like it could be following logistic growth, so let’s try to fit the data to that model. First, let’s make a new variable with just the data we want to fit.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e_nigrum &lt;-<span class="st"> </span>plant_data %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(site ==<span class="st"> </span><span class="dv">3</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(habitat ==<span class="st"> &quot;Tundra&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(treatment ==<span class="st"> &quot;rodentexclosure&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(year, empetrum_nigrum) </code></pre></div>
<p>Now we define a logistic model function so that we can numerically generate the model’s solution and compare it to the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logistic_fn &lt;-<span class="st"> </span>function(t, state, parameters) {
  <span class="co"># Calculates dN/dt for the logistic equation</span>
  
  <span class="co"># t: time point at which to evaluate derivative (doesn&#39;t actually change anything in this example)</span>
  <span class="co"># state: vector of variables (here it&#39;s just N)</span>
  <span class="co"># parameters: vector of model parameters c(r, K)</span>
  
  N &lt;-<span class="st"> </span>state 
  
  r &lt;-<span class="st"> </span>parameters[<span class="dv">1</span>] <span class="co"># the first element of the parameters vector is r</span>
  K &lt;-<span class="st"> </span>parameters[<span class="dv">2</span>] <span class="co"># the second element of the parameters vector is K</span>

  <span class="co">#rate of change</span>
  dN &lt;-<span class="st"> </span>r *<span class="st"> </span>N *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>N /<span class="st"> </span>K)
    
  <span class="co">#return rate of change</span>
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dN)))
}</code></pre></div>
<p>Let’s try running a single numerical solution and plotting it alongside the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(deSolve)

parameters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">r =</span> <span class="fl">0.5</span>, <span class="dt">K =</span> <span class="dv">150</span>)
state &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">N =</span> e_nigrum[<span class="dv">1</span>,<span class="dv">2</span>]) <span class="co"># the first row and second column is the initial population size</span>
times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">14</span>, <span class="dt">by =</span> <span class="dv">1</span>) <span class="co"># make the same time vector as the data</span>

result &lt;-
<span class="st">  </span><span class="kw">ode</span>(
  <span class="dt">y =</span> state,
  <span class="dt">times =</span> times,
  <span class="dt">func =</span> logistic_fn,
  <span class="dt">parms =</span> parameters
  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot</span>
result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)

p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(e_nigrum) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> empetrum_nigrum))

p1 +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Now we’ll define a grid of <span class="math inline">\(r\)</span> and <span class="math inline">\(K\)</span> values to try, then calculate a numerical solution for each combination of parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rvals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="dt">by =</span> <span class="fl">0.05</span>)
Kvals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">120</span>, <span class="dv">180</span>, <span class="dt">by =</span> <span class="dv">5</span>)

<span class="co"># initialize empty matrix for likelihood calculation</span>
residuals_surface =<span class="st"> </span><span class="kw">matrix</span>(, <span class="dt">nrow =</span> <span class="kw">length</span>(rvals), <span class="dt">ncol =</span> <span class="kw">length</span>(Kvals)) 

<span class="co"># loop over values of r and k, calculate log likelihood</span>
for (i in <span class="kw">seq</span>(<span class="kw">length</span>(rvals))){
  for (j in <span class="kw">seq</span>(<span class="kw">length</span>(Kvals))){
    result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, 
                  <span class="dt">times =</span> times, 
                  <span class="dt">func =</span> logistic_fn,
                  <span class="dt">parms =</span> <span class="kw">c</span>(<span class="dt">r =</span> rvals[i], <span class="dt">K =</span> Kvals[j]))
    result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)
    residuals &lt;-<span class="st"> </span>result$N -<span class="st"> </span>e_nigrum$empetrum_nigrum
    residuals_surface[i,j] &lt;-<span class="st"> </span><span class="kw">sum</span>(residuals^<span class="dv">2</span>)
  }
}</code></pre></div>
<p><strong>Added:</strong> The more R way of doing the above code is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logistic_pred_fn &lt;-<span class="st"> </span>function(r, K) {
    result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, 
                  <span class="dt">times =</span> times, 
                  <span class="dt">func =</span> logistic_fn,
                  <span class="dt">parms =</span> <span class="kw">c</span>(<span class="dt">r =</span> r, <span class="dt">K =</span> K))
    result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)
    residuals &lt;-<span class="st"> </span>result$N -<span class="st"> </span>e_nigrum$empetrum_nigrum
    <span class="kw">sum</span>(residuals^<span class="dv">2</span>)
}

rvals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="dt">by =</span> <span class="fl">0.05</span>)
Kvals &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">120</span>, <span class="dv">180</span>, <span class="dt">by =</span> <span class="dv">5</span>)
<span class="co"># Create a two column data frame with every combination of rvals and Kvals</span>
params &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">r =</span> rvals, <span class="dt">K =</span> Kvals)

<span class="co"># Apply the logistic_pred_fn to each combination of rvals and Kvals.</span>
<span class="co"># This is known as vectorization, which is R&#39;s strength.</span>
resids &lt;-<span class="st"> </span><span class="kw">mapply</span>(logistic_pred_fn,
                 params$r, <span class="co"># First arg in logistic_pred_fn</span>
                 params$K) <span class="co"># Second arg in logistic_pred_fn</span>
resids &lt;-<span class="st"> </span><span class="kw">matrix</span>(resids, <span class="dt">nrow =</span> <span class="kw">length</span>(rvals), <span class="dt">ncol =</span> <span class="kw">length</span>(Kvals))

<span class="co"># Check if they are the same</span>
<span class="kw">identical</span>(resids, residuals_surface)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>We can use the library <code>lattice</code> to plot the surface:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lattice)

<span class="kw">wireframe</span>(
  residuals_surface,
  <span class="dt">shade =</span> <span class="ot">TRUE</span>,
  <span class="dt">xlab =</span> <span class="st">&quot;R&quot;</span>,
  <span class="dt">ylab =</span> <span class="st">&quot;K&quot;</span>,
  <span class="dt">scales =</span> <span class="kw">list</span>(<span class="dt">arrows =</span> <span class="ot">FALSE</span>) <span class="co"># fix so that axes are correct numbers</span>
  ) </code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Now we extract the values of <span class="math inline">\(r\)</span> and <span class="math inline">\(K\)</span> that minimize the sum of residuals:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">best_fit &lt;-<span class="st"> </span><span class="kw">which</span>(residuals_surface ==<span class="st"> </span><span class="kw">min</span>(residuals_surface), <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>)

r_fit &lt;-<span class="st"> </span>rvals[best_fit[<span class="dv">1</span>]] <span class="co"># r is varied across the rows of the surface</span>
K_fit &lt;-<span class="st"> </span>Kvals[best_fit[<span class="dv">2</span>]] <span class="co"># K is varied across the columns of the surface</span></code></pre></div>
<p>And now we can plot the best fit curve with the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">result &lt;-
<span class="st">  </span><span class="kw">ode</span>(
  <span class="dt">y =</span> state,
  <span class="dt">times =</span> times,
  <span class="dt">func =</span> logistic_fn,
  <span class="dt">parms =</span> <span class="kw">c</span>(<span class="dt">r =</span> r_fit, <span class="dt">K =</span> K_fit)
  )
  
result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)

p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(e_nigrum) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> empetrum_nigrum))

p2 +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>You can do this process with more than two parameters as well, but the search space will be larger and the simulations necessary will take longer.</p>
</div>
<div id="assumptions-of-least-squares" class="section level3">
<h3>Assumptions of least squares</h3>
<p>When is it appropriate to use least squares to fit your data?</p>
<p>Assumptions of least squares:</p>
<ul>
<li>The noise or error is <strong>Gaussian-distributed</strong>: the most likely value for a data point is the predicted value, but there is a Gaussian distribution with some width that determines how likely it is that the data will have a different value.</li>
<li>All data points have the same variance in their error: the width of the Gaussian distribution governing the error is the same for each data point. This can be modified though if it’s not a good assumption.</li>
<li>The noise or error is only in the dependent variable(s), not in the independent variable(s).</li>
<li>Each data point is independent of the other data points.</li>
</ul>
<p><em>Note</em>: in all this talk of fitting, what we’re doing doesn’t tell us <em>which</em> model fits our data best, only what parameters for a particular model fit best. The choice of model is up to us. There are ways to distinguish between fits for different models which will be discussed next class.</p>
</div>
</div>
<div id="extras-maximum-likelihood" class="section level2">
<h2>Extras: Maximum Likelihood</h2>
<p>Maximum likelihood is a way of finding parameters of a given probability distribution that best match data. It answers the question: which paremeter(s) make the data most likely to have occured?</p>
<p>Likelihood is defined as <span class="math inline">\(P(\text{data} | \text{model})\)</span>, which you can read as <em>the probability of the data given the model</em>. This is subtly different from <span class="math inline">\(P(\text{model} | \text{data})\)</span>, the probability of the model given the data, which is what you’re really after. But according to Bayes’ theorem, these two quantities are proportional, and so in practice, maximizing the likelihood is equivalent to maximizing the probability of a particular model given your data.</p>
<p>Bayes’ theorem, for the curious:</p>
<p><span class="math display">\[ P(A | B) = \frac{P(B | A)P(A)}{P(B)}\]</span></p>
<div id="least-squares-from-maximum-likelihood" class="section level3">
<h3>Least squares from maximum likelihood</h3>
<p>Least squares is the maximum likelihood solution for the assumption that errors are Gaussian distributed. This assumption can be formulated like this: for a set of data <span class="math inline">\(y\)</span> as a function of <span class="math inline">\(x\)</span>, let <span class="math inline">\(e_i\)</span> be the difference between the predicted and measured value of <span class="math inline">\(y\)</span> at point <span class="math inline">\(x_i\)</span>. We assume <span class="math inline">\(e_i\)</span> follows a <strong>Gaussian</strong> or <strong>normal</strong> distribution with mean <span class="math inline">\(0\)</span> and variance <span class="math inline">\(\sigma\)</span>:</p>
<p><span class="math display">\[P(e_i) = \frac{1}{\sqrt{2 \pi \sigma^2}} \text{e}^{-\frac{e_i^2}{2\sigma^2}}\]</span></p>
<p>We also assume that each data point <span class="math inline">\(y_i\)</span> is independent, so the probability for the entire dataset is a product of all the probabilities for each data point:</p>
<p><span class="math display">\[P(\vec{e}) = P(e_1)P(e_2) ... P(e_N) = \prod_{i=1}^N P(e_i) \]</span></p>
<p>This is the <strong>likelihood</strong>, this is the quantity we want to maximize. To make our lives easier, we can also maximize the logarithm of the likelihood instead, since the logarithm is an increasing function and its maximum will still be in the same spot.</p>
<p>The log-likelihood is</p>
<p><span class="math display">\[\sum_{i=1}^N \text{log}P(e_i) = \sum_{i=1}^N \left( \text{log} \frac{1}{\sqrt{2 \pi \sigma^2}} - \frac{e_i^2}{2\sigma^2} \right)\]</span></p>
<p><span class="math display">\[ = N \text{log} \frac{1}{\sqrt{2 \pi \sigma^2}} - \frac{1}{2\sigma^2}\sum_{i=1}^N e_i^2\]</span></p>
<p>The first term is a constant, and so we can forget about it when looking for the maximum. What we’re left with is wanting to maximize</p>
<p><span class="math display">\[- \frac{1}{2\sigma^2}\sum_{i=1}^N e_i^2\]</span></p>
<p>Since <span class="math inline">\(\sigma\)</span> is a constant, we can drop the prefactor as well. Finally, we can change the sign and <em>minimize</em> what’s left:</p>
<p><span class="math display">\[\sum_{i=1}^N e_i^2\]</span></p>
<p>But remember that <span class="math inline">\(e_i\)</span> is just the difference between the predicted <span class="math inline">\(y_i\)</span> and the actual data point <span class="math inline">\(y_i\)</span>, so the quantity above is just the sum of the squares of the residuals, exactly what we want to minimize in least squares.</p>
</div>
</div>
<div id="extras-using-the-analytic-solution-for-a-model-to-fit-data" class="section level2">
<h2>Extras: using the analytic solution for a model to fit data</h2>
<p>Instead of simulating the model, if you know the analytic solution you can use it directly like we did with the exponential model.</p>
<p>This is the analytic solution for the logistic model:</p>
<p><span class="math display">\[N(t) = \frac{N_0 K\text{e}^{rt}}{N_0(\text{e}^{rt}-1)+K}\]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logistic_solution &lt;-<span class="st"> </span>function(N0, t, r, K) {
  <span class="co"># Calculates N at time t using the analytic solution for the logistic equation</span>
  
  <span class="co"># N0: initial population size</span>
  <span class="co"># t: time at which to calculate N</span>
  <span class="co"># r: growth rate</span>
  <span class="co"># K: carrying capacity</span>
  
  C &lt;-<span class="st"> </span>(K-N0)/N0 <span class="co"># constant of integration</span>

  N &lt;-<span class="st"> </span>K*<span class="kw">exp</span>(r*t)/(<span class="kw">exp</span>(r*t)+C)
  
  <span class="kw">return</span>(N)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rvals =<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="dt">by =</span> <span class="fl">0.05</span>)
Kvals =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">120</span>, <span class="dv">180</span>, <span class="dt">by =</span> <span class="dv">5</span>)

residuals_surface =<span class="st"> </span><span class="kw">matrix</span>( , <span class="dt">nrow =</span> <span class="kw">length</span>(rvals), <span class="dt">ncol =</span> <span class="kw">length</span>(Kvals)) <span class="co"># initialize matrix for likelihood calculation</span>

initial_condition &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">N =</span> e_nigrum[<span class="dv">1</span>,<span class="dv">2</span>])
times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">14</span>, <span class="dt">by =</span> <span class="dv">1</span>) <span class="co"># make the same time vector as the data</span>

<span class="co"># loop over values of r and k, calculate log likelihood</span>
for (i in <span class="kw">seq</span>(<span class="kw">length</span>(rvals))){
  for (j in <span class="kw">seq</span>(<span class="kw">length</span>(Kvals))){
    Ndata &lt;-<span class="st"> </span><span class="kw">logistic_solution</span>(initial_condition, times, rvals[i], Kvals[j])
    result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(times, Ndata)
    residuals &lt;-<span class="st"> </span>result$N -<span class="st"> </span>e_nigrum$empetrum_nigrum
    residuals_surface[i,j] &lt;-<span class="st"> </span><span class="kw">sum</span>(residuals^<span class="dv">2</span>)
  }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">wireframe</span>(residuals_surface,
          <span class="dt">shade=</span><span class="ot">TRUE</span>,
          <span class="dt">xlab =</span> <span class="st">&quot;R&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;K&quot;</span>,
          <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>)) </code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<p>Now to extract the values of <span class="math inline">\(r\)</span> and <span class="math inline">\(K\)</span> that minimize the sum of residuals:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">best_fit &lt;-<span class="st"> </span><span class="kw">which</span>(residuals_surface ==<span class="st"> </span><span class="kw">min</span>(residuals_surface), <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>)

r_fit &lt;-<span class="st"> </span>rvals[best_fit[<span class="dv">1</span>]] <span class="co"># r is varied across the rows of the surface</span>
K_fit &lt;-<span class="st"> </span>Kvals[best_fit[<span class="dv">2</span>]] <span class="co"># K is varied across the columns of the surface</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, <span class="dt">times =</span> times, <span class="dt">func =</span> logistic_fn, <span class="dt">parms =</span> <span class="kw">c</span>(<span class="dt">r =</span> r_fit, <span class="dt">K =</span> K_fit))

result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)

p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(e_nigrum) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> empetrum_nigrum))

p2 +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time +<span class="st"> </span><span class="dv">1998</span>, <span class="dt">y =</span> N), result, <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>)</code></pre></div>
<p><img src="lec10-modelling_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
</div>


<hr>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. See the <a href="LICENSE.html">licensing</a> page for more details about copyright information.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
