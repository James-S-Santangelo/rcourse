---
title: 'Assignment 5: Linear mixed-effects models and randomization tests (8 marks)'
output:
    html_document:
        toc: false
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

*To submit this assignment, upload the full document on blackboard,
including the original questions, your code, and the output. Submit
your assignment as a knitted `.pdf` (preferred) or `.html` file.*

1. In this exercise, we will once again use the data of Santangelo _et al._ (2019) that you used in assignment 4. Let's go ahead and load in the data. See assignment 4 if you need a refresher on the details of the experiment and the dataset. (4.25 marks total)

    ```{r message=FALSE, warning=FALSE}
    library(tidyverse)
    library(lme4)
    library(lmerTest)
    
    
    Santangelo_data <- "https://uoftcoders.github.io/rcourse/data/Santangelo_JEB_2018.csv"
    download.file(Santangelo_data, "Santangelo_JEB_2018.csv")
    Santangelo_data <- read_csv("Santangelo_JEB_2018.csv", 
                                col_names = TRUE)
    glimpse(Santangelo_data)
    head(Santangelo_data)
    ```


    a. Model selection works best when there are no missing values in your dataset. We will be identifying the best model that predict variation in flowering time (`Flower.date`) across plants. Create a dataset that excludes rows where there is missing flowering date data. (0.25 marks)
    
```{r}
Santangelo_data <- Santangelo_data %>% 
    filter(!is.na(Flower.date))
```
    
    b. Create a mixed-effects model with Flowering date (`Flower.date`) as the response variable and HCN, Herbivory, and Pollination as main effect, fixed-effect predictors. Also include the HCN x Herbivory and HCN x Pollination treatment interactions as fixed-effect. Be sure to account for variation due to `Genotype`, `Block` and the `Genotype` by `Herbivory` interactions by including these terms as random effects. This will be our saturated model. (0.5 marks)
    
```{r}
fullModel <- lmer(Flower.date ~ HCN*Herbivory*Pollination + (1|Genotype) + (1|Block) + (1|Genotype:Herbivory), data = Santangelo_data)
```
    
    
    c. We will generate a reduced model from the saturated model in (a). Should we use AIC or AIC~c~. Why? Show your calculation. (0.5 marks)
    
```{r}
# Can use AIC
nrow(Santangelo_data) / 3
```
    
    
    d. Using the approach described in lecture 11, optimize the random effect structure of this model. Show the AIC/AIC~c~ output for each model of varying random effect strucure. Describe in one sentence what the optimal random effect structure of the model is and why. (0.5 marks)
    
```{r}
fullModel <- lmer(Flower.date ~ HCN*Herbivory*Pollination + (1|Genotype) + (1|Block) + (1|Genotype:Herbivory), data = Santangelo_data,
                  REML = TRUE)

model_noRandInteraction <- lmer(Flower.date ~ HCN*Herbivory*Pollination + (1|Genotype) + (1|Block), data = Santangelo_data,
                  REML = TRUE)

model_noBlock <- lmer(Flower.date ~ HCN*Herbivory*Pollination + (1|Genotype) + (1|Genotype:Herbivory), data = Santangelo_data,
                  REML = TRUE)

model_noBlockOrInteraction <- lmer(Flower.date ~ HCN*Herbivory*Pollination + (1|Genotype), data = Santangelo_data,
                  REML = TRUE)

AIC(fullModel, model_noRandInteraction, model_noBlock, model_noBlockOrInteraction)

# The model that includes only genotype is the best supported model based on AIC
```

    
    e. Using the model with the optimal random-effect structure identified in (c), find the optimal fixed-effect structure. Be sure to show all the models and their AIC/AIC~c~ scores. (1.5 mark)
    
```{r}
fullModel <- lmer(Flower.date ~ HCN + Herbivory + Pollination + HCN:Herbivory + HCN:Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_HCNOnly <- lmer(Flower.date ~ HCN + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_HerbOnly <- lmer(Flower.date ~ Herbivory + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_PollOnly <- lmer(Flower.date ~ Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_HerbHCNnoInter <- lmer(Flower.date ~ HCN + Herbivory + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_PollHCNnoInter <- lmer(Flower.date ~ HCN + Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_HerbHCN <- lmer(Flower.date ~ HCN + Herbivory + HCN:Herbivory + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_PollHCN <- lmer(Flower.date ~ HCN + Pollination + HCN:Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_HerbPoll <- lmer(Flower.date ~ Herbivory + Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_noHCNPollInter <- lmer(Flower.date ~ HCN + Herbivory + Pollination + HCN:Herbivory + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_noHCNHerbInter <- lmer(Flower.date ~ HCN + Herbivory + Pollination + HCN:Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_noInters <- lmer(Flower.date ~ HCN + Herbivory + Pollination + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)

model_noFix <- lmer(Flower.date ~ 1 + (1|Genotype), data = Santangelo_data,
                  REML = FALSE)



AIC(fullModel, model_HCNOnly, model_HerbOnly, model_PollOnly, model_HerbHCNnoInter, model_PollHCNnoInter, model_HerbHCN, 
    model_PollHCN, model_HerbPoll, model_noHCNPollInter, model_noHCNHerbInter, model_noInters, model_noFix)

# The most supported model is one with herbivory only.
summary(fullModel)

# There should be 13 models total
options(na.action = "na.fail")
allModels <- MuMIn::dredge(fullModel, evaluate = TRUE, rank = "AIC")
options(na.action = "na.omit")
```
    
    
    f. Based on the AIC/AIC~c~ output from (d), generate a your final model with both optimized fixed and random effects. Summarize the model and interpret its output. Is there a significant effect of any treatment? If so, which one(s) and in which direction. Make a statement about the significant treatments' effect on flowering date. Use the model's output to support your answer. You only need to interpret significant main effects here (i.e. not interactions). (0.5 marks)
    
    g. Do you think we were justified in interpreting a single model? Why or why not? What alternative approach could we have used? (0.25 marks).
    
```{r}
# Model averaging since many models are within 2 AIC points
```

    h. Use `dplyr` and `ggplot2` to plot the flowering date of plants by the _main_ effect that showed a significant effect in the optimized model above. The figure should show the mean plus and minus a single standard error of the mean. Suggest one biological interpretation of the pattern you see in the figure and in the model (i.e. why do you think this would happen). (0.25 marks)
    


